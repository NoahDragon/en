<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Set up VPN with transparent proxy on DigitalOcean | A Developer in Limbo</title><meta name="author" content="Abner Chou"><meta name="description" content="Developer, Blog, English"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Set up VPN with transparent proxy on DigitalOcean"><meta property="og:site_name" content="A Developer in Limbo"><meta property="og:image" content="undefined"><link href="/favicon.png" rel="icon"><link rel="stylesheet" href="/css/themes/yeti.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><script src="/js/jquery-2.0.3.min.js"></script></head></html><body><nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation"><div class="container"><button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">A Developer in Limbo</a><div class="collapse navbar-collapse nav-menu"><ul class="nav navbar-nav"><li><a href="/archives" title="All the articles."><i class="fa fa-archive"></i>Archives</a></li><li><a href="/categories" title="All the categories."><i class="fa fa-folder"></i>Categories</a></li><li><a href="/tags" title="All the tags."><i class="fa fa-tags"></i>Tags</a></li><li><a href="/about" title="About me."><i class="fa fa-user"></i>About</a></li></ul></div></div></nav><div class="clearfix"></div><div class="container"><div class="content"><div class="page-header page-header-inverse"><h1 class="title title-inverse">Set up VPN with transparent proxy on DigitalOcean</h1></div><div class="row post"><div id="top_meta"></div><div class="col-md-9"><div class="mypage"><p>Recently I just rent a VPS on <a href="https://www.digitalocean.com" target="_blank" rel="external">Digital Ocean</a>,<br>which is cheap for a student and who is price sensitive.<br>As it gives you all the controls of an OS, it likes a remote compute machine.<br>Meanwhile, you could do anything as you have your own server.</p><a id="more"></a><p>Therefore, it comes to my mind to create a VPN server.<br>VPN is a virtual private network that extends a private network across a public network,<br>which usually used to bypass firewalls or increase access speed.<br>Proxy is a server that acts as an intermediary for requests from clients seeking resources from other servers.<br>It needs to be set in software application’s configuration.<br>VPN and Proxy both could hide your ip.<br>The differences between them are listed following:</p><table><thead><tr><th style="text-align:left"></th><th style="text-align:center">VPN</th><th style="text-align:center">Proxy</th></tr></thead><tbody><tr><td style="text-align:left">Protocols&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td style="text-align:center">Support any Protocols</td><td style="text-align:center">Support certain Protocols, such as HTTP, SOCKS</td></tr><tr><td style="text-align:left">Softwares</td><td style="text-align:center">Any softwares that can run on the machine &nbsp;&nbsp;&nbsp;&nbsp;</td><td style="text-align:center">Softwares support proxy configuration</td></tr><tr><td style="text-align:left">Price</td><td style="text-align:center">High if you rent from vpn provider</td><td style="text-align:center">Low</td></tr><tr><td style="text-align:left">Speed</td><td style="text-align:center">Varies depend on number of users<br>usually depends on servers</td><td style="text-align:center">Depend on servers</td></tr><tr><td style="text-align:left">Security</td><td style="text-align:center">Encryption (128-bit to 2048-bit)</td><td style="text-align:center">Not encrypted</td></tr></tbody></table><p><br></p><p>Because of the encryption, every accesses through VPN retrive the objects directly from the source.<br>This could slow down the user experience when hits a same object multiple times, such as icons in a webpage.<br>If there is a way that could cache web objects into VPN server, that will significantly increase the access speed, which get objects from local disk instead of downloading from source website.<br>Here, I should introduce the transparent proxy, which usually sets on the gateway and caches content from WWW requests.<br>It calls transparent because client side does not need any configuration.<br>Hence, every WWW requests through VPN need go to transparent proxy.</p><p>This installation guide is tested on Ubuntu 14.04 64bit.<br>VPN is set up by <a href="http://en.wikipedia.org/wiki/Point-to-Point_Tunneling_Protocol" target="_blank" rel="external">pptp</a>.<br>Transparent proxy is on <a href="http://www.squid-cache.org" target="_blank" rel="external">Squid3</a>.</p><ul><li><strong>pptp installation</strong></li></ul><p>In terminal, type the command bellow to install pptp server:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install pptpd</span><br></pre></td></tr></table></figure><p></p><p>To restrict user access your VPN server, you also need to add users and passwords in <code>/etc/ppp/chap-secets</code>.<br>In the client column is user’s name, the secret column is for passwords.<br>I masked mine for privacy.</p><p><img src="/images/pics/user_password.jpg" alt="Set user and password"></p><p>Add the following DNS to <code>/etc/ppp/pptpd-options</code>:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ms-dns 8.8.8.8</span><br><span class="line">ms-dns 8.8.4.4</span><br></pre></td></tr></table></figure><p></p><p>Restart pptp server by command <code>service pptpd restart</code>. Check if it is running by <code>netstat -alpn | grep :1723</code>.</p><p>You also should enable the IP forwarding on your pptp server.<br>This would transfer the package between public ip and private ips on your server.<br>Open <code>/etc/sysctl.conf</code>, add the following line if not exist: <code>net.ipv4.ip_forward = 1</code>.<br>Then run <code>sysctl -p</code> to make the change effective.</p><p>Create NAT rule for iptables, and your VPN is ready to use:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables --table nat --append POSTROUTING -o eth0 -j MASQUERADE &amp;&amp; iptables-save</span><br></pre></td></tr></table></figure><p></p><ul><li><strong>Squid3 installation</strong></li></ul><p>Similar to pptpd, typing the following in terminal:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install squid</span><br><span class="line">update-rc.d squid3 defaults</span><br></pre></td></tr></table></figure><p></p><p>The proxy is usable now, but it is the normal proxy with default settings.<br>To change it to transparent proxy, we need to edit the <code>/etc/squid3/squid.conf</code> file.<br>The squid.conf follows the rules of allow/deny order.<br>It obeys the first come first serve, the first matched rule will apply.<br>For example, if you put “deny all” at the first line of squid.conf, then the proxy denies all request.<br>If a rule does not indicate in squid.conf, then it defaults as deny.</p><p>First, find the line <code>http_port 3128</code>, change it to <code>http_port 3128 transparent</code>.<br><strong>this is important</strong></p><p>Second, add the following rules:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acl myhost src 192.168.0.1</span><br><span class="line">http_access allow myhost</span><br><span class="line">acl mymachine src 10.0.0.0/16</span><br><span class="line">http_access allow mymachine</span><br></pre></td></tr></table></figure><p></p><p>The ‘192.168.0.1’ is my public ip, and the ‘10.0.0.0/16’ is my private ips.<br>Restart squid <code>sudo service squid3 restart</code>.</p><p>Finally, we set the iptables to redirect all the traffic through 80 port to 3128 port that is our transparent proxy.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -i ppp0 -p tcp -m tcp --dport 80 -j REDIRECT --to-port 3128</span><br></pre></td></tr></table></figure><p></p><p>The transparent proxy is set up.</p><ul><li><strong>Restore iptables rules while system start up</strong></li></ul><p>Right now, you couldn’t restart the system, otherwise the iptables will be set to empty again.<br>But you can input the previous iptables commands again to solve this.</p><p>Here I introduce a method that will do it once and for all.</p><p>Save iptables into <code>/etc/network/iptables.rules</code> by <code>iptables-save &gt; /etc/network/iptables.rules</code></p><p>Open <code>/etc/rc.local</code> and add the following line before “exit 0”:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/iptables-restore &lt; /etc/network/iptables.rules</span><br></pre></td></tr></table></figure><p></p><p>Then our saved iptables rules will be loaded every time the system start up.</p><p>Enjoy your VPN server with transparent proxy!</p></div><div><center><div class="pagination"><ul class="pagination"><li class="prev"><a href="/Blog/e4c9ee8f/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li><li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li><li class="next"><a href="/Blog/e0efd72f/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li></ul></div></center></div><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a> <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a> <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a> <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a> <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a> <a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a> <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a> <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"1",bdSize:"24"},share:{}},document)(0)[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)]</script><section id="comment"><h2 class="title">留言</h2><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><div id="side_meta"><div class="col-md-3" id="post_meta"><div class="meta-widget"><i class="fa fa-clock-o"></i> 2014-07-12</div><div class="meta-widget"><a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a><ul id="categorys" class="tag_box list-unstyled collapse in"><li></li><li><a href="/categories/VPN/">VPN<span>1</span></a></li><li><a href="/categories/VPN/pptp/">pptp<span>1</span></a></li><li><a href="/categories/VPN/pptp/Squid/">Squid<span>1</span></a></li><li><a href="/categories/VPN/pptp/Squid/Transparent-Proxy/">Transparent Proxy<span>1</span></a></li><li><a href="/categories/VPN/pptp/Squid/Transparent-Proxy/Proxy/">Proxy<span>1</span></a></li><li><a href="/categories/VPN/pptp/Squid/Transparent-Proxy/Proxy/DigitalOcean/">DigitalOcean<span>1</span></a></li><li><a href="/categories/VPN/pptp/Squid/Transparent-Proxy/Proxy/DigitalOcean/VPS/">VPS<span>1</span></a></li></ul></div><div class="meta-widget"></div><hr></div></div></div><script type="text/javascript">var disqus_shortname="abnerchou";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></div></div><div class="container-narrow"><footer><p>&copy; 2016 Abner Chou with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.</p></footer></div><a id="gotop" href="#"><span>▲</span></a><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/search.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script><script type="text/javascript">var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;searchFunc(path,"local-search-input","local-search-result")</script></body>